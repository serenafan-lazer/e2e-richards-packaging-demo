# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a Playwright E2E testing repository for a Shopify theme. It contains a specialized workflow for creating, generating, and healing E2E tests through a three-phase agent-based system (plan → generate → heal).

## Commands

### Test Execution
```bash
# Run all E2E tests
npm run test:all

# Run tests with UI mode (interactive)
npm run test:ui

# Run tests in debug mode
npm run test:debug

# View test report
npm run test:report
```

### Test Development
```bash
# Run specific test file
npx playwright test --config e2e/playwright.config.ts <test-file>.spec.ts

# Run tests for specific project (browser)
npx playwright test --config e2e/playwright.config.ts --project=chromium

# Run tests in headed mode
npx playwright test --config e2e/playwright.config.ts --headed
```

## Architecture

### Test Generation Workflow

This repository uses a unique three-phase workflow for E2E test creation via the `/playwright-test-writer` slash command:

**Phase 1: Test Planning** (`playwright-test-planner` agent)
- Explores component functionality in live preview environment
- Uses MCP browser automation tools to understand user interactions
- Creates detailed test plan in `e2e/testplan/e2e-{feature-name}-test-plan.md`
- Documents test scenarios, user flows, edge cases, and POM structure

**Phase 2: Test Generation** (`playwright-test-generator` agent)
- Reads test plan from Phase 1
- Generates test files with `.spec.ts` suffix (never `.test.ts`)
- Creates Page Object Model classes in `e2e/pages/`
- Implements all scenarios from the test plan

**Phase 3: Test Execution & Healing** (`playwright-test-healer` agent)
- Runs generated tests
- Automatically fixes failures (max 5 attempts)
- Applies intelligent fixes for common issues (selectors, timing, state management)
- Provides comprehensive failure reports if tests still fail

### Directory Structure

```
e2e/
├── playwright.config.ts      # Playwright configuration
├── global-setup.ts            # Authentication and global setup
├── storageState.json          # Saved auth state (generated)
├── pages/                     # Page Object Model classes
│   ├── BasePage.ts           # Base class with common functionality
│   └── PasswordPage.ts       # Shopify password page handler
├── helpers/                   # Reusable utilities
│   └── constant.ts           # Environment variables and constants
├── testplan/                  # Test plans generated by planner agent
│   └── e2e-*-test-plan.md
└── tests/                     # Test files (*.spec.ts)
```

### Environment Configuration

Tests run against a Shopify preview theme. Required environment variables in `.env`:

```env
TEST_URL=https://your-store.myshopify.com
STORE_PASSWORD=your-password-here
TEST_THEME_ID=your-theme-id
```

The `PREVIEW_URL` is automatically constructed as `TEST_URL?preview_theme_id=TEST_THEME_ID`.

### Authentication Flow

- `global-setup.ts` runs before all tests
- Navigates to preview URL and handles Shopify password protection via `PasswordPage`
- Saves authentication state to `e2e/storageState.json`
- All tests reuse this state (configured in `playwright.config.ts`)

### Page Object Model Pattern

All Page Objects extend `BasePage` which provides:
- `goto(path)` - Navigate to paths with automatic URL construction
- `getUrl(path)` - Construct full URLs with TEST_URL
- `waitForApiCall(urlPattern, options)` - Wait for specific network requests
- `isMobileViewport()` - Check if viewport is mobile-sized

Example structure:
```typescript
export class ProductPage extends BasePage {
  readonly addToCartButton: Locator;
  readonly productTitle: Locator;

  constructor(page: Page) {
    super(page);
    this.addToCartButton = page.getByRole('button', { name: 'Add to cart' });
    this.productTitle = page.getByRole('heading', { level: 1 });
  }

  async addToCart(quantity: number = 1) {
    // Method implementation
  }
}
```

## Testing Philosophy

### Test Focus (DO TEST)
- Core positive user flows (happy paths)
- Negative scenarios (validation failures, error handling)
- Data flow and state management
- Functional user interactions

### Explicitly Excluded (DO NOT TEST)
- Responsive behavior or viewport-specific functionality
- Accessibility compliance (ARIA, WCAG)
- Loading states and debounce behavior
- Edge cases and boundary conditions

### Selector Priority
1. Role-based: `page.getByRole('button', { name: 'Submit' })`
2. Label-based: `page.getByLabel('Email address')`
3. Text-based: `page.getByText('Success')`
4. Test ID: `page.getByTestId('product-price')`
5. CSS selectors (last resort)

### Waiting Strategy
- Rely on Playwright's auto-waiting for actions (preferred)
- Use web-first assertions with built-in retry: `expect(element).toBeVisible()`
- Wait for specific elements when needed: `element.waitFor({ state: 'visible' })`
- Wait for network responses: `page.waitForResponse(resp => ...)`
- **NEVER** use `waitForTimeout()` or `waitForLoadState('networkidle')`

## Browser Projects

Tests run across multiple browsers/devices (configured in `playwright.config.ts`):
- `chromium` - Desktop Chrome
- `firefox` - Desktop Firefox
- `safari` - Desktop Safari
- `mobile-chrome` - Pixel 5 emulation
- `mobile-safari` - iPhone 12 emulation

## Slash Commands

### `/playwright-test-writer`

Creates comprehensive E2E tests using the three-phase workflow.

**Usage:**
```
/playwright-test-writer <component-path-or-description>
```

**Examples:**
```
/playwright-test-writer frontend/js/islands/country-switcher.ts
/playwright-test-writer product gallery functionality
/playwright-test-writer checkout flow
```

**What it does:**
1. Launches test planner agent to research and create test plan
2. Launches test generator agent to create test files with POM structure
3. Launches test healer agent to run tests and auto-fix failures
4. Provides comprehensive report with all generated files and test status

## Key Patterns

### Test File Naming
- Component tests: `<component-name>.spec.ts` (e.g., `country-switcher.spec.ts`)
- Page tests: `<page-name>.spec.ts` (e.g., `checkout.spec.ts`)
- Always use `.spec.ts` suffix (never `.test.ts`)

### Test Structure
```typescript
import { test, expect } from '@playwright/test';

test.describe('Feature Name', () => {
  test.beforeEach(async ({ page }) => {
    // Setup for each test
  });

  test('should perform specific action', async ({ page }) => {
    // Test implementation
  });

  test('should handle error case', async ({ page }) => {
    // Negative test
  });
});
```

### Multi-Step Flows
Use `test.step()` for complex scenarios:
```typescript
test('complete checkout flow', async ({ page }) => {
  await test.step('Add product to cart', async () => {
    // Step 1
  });

  await test.step('Proceed to checkout', async () => {
    // Step 2
  });

  await test.step('Complete purchase', async () => {
    // Step 3
  });
});
```

### Island Component Testing
For components with conditional loading (client:idle, client:visible, client:media):
```typescript
// Wait for custom element registration
await page.waitForFunction(() => {
  return window.customElements.get('product-gallery') !== undefined;
});

// For client:visible components, scroll into view first
await component.scrollIntoViewIfNeeded();
```

## Configuration Files

### `playwright.config.ts`
- Test directory: `./tests`
- Timeout: 30 seconds
- Fully parallel execution
- Retries: 2 in CI, 0 locally
- Uses `storageState.json` for authentication
- HTML reporter enabled

### `global-setup.ts`
- Handles Shopify password-protected store access
- Navigates to preview URL with theme ID
- Saves authenticated state to `storageState.json`

### `constant.ts`
- Loads environment variables from `.env`
- Exports TEST_URL, STORE_PASSWORD, TEST_THEME_ID, PREVIEW_URL
- Provides fallback defaults for local development

## Best Practices

1. **Page Objects**: Always encapsulate page interactions in POM classes
2. **Semantic Selectors**: Prefer accessible selectors (getByRole, getByLabel)
3. **Auto-Waiting**: Let Playwright handle waits automatically
4. **Test Isolation**: Each test should be independent and self-contained
5. **Test Steps**: Use test.step() for multi-step flows
6. **No Arbitrary Waits**: Never use waitForTimeout()
7. **TypeScript Types**: Use proper types (avoid 'any')
8. **JSDoc Comments**: Document complex page object methods

## Troubleshooting

### Tests Failing Due to Selectors
- Run in UI mode: `npm run test:ui`
- Use Playwright inspector in debug mode
- Check if element is in shadow DOM or iframe
- Verify element is actually visible/enabled

### Authentication Issues
- Delete `e2e/storageState.json` and regenerate
- Check STORE_PASSWORD in `.env`
- Verify TEST_THEME_ID is correct

### Timeout Errors
- Check if page is loading correctly
- Use `--headed` flag to see what's happening
- Add explicit wait for specific network responses
- Increase timeout in playwright.config.ts if needed
